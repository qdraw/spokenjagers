<!doctype html>
<html>
    <head>
		<meta charset="UTF-8">
    	<title>Socket.io Test</title>

    <script src="/socket.io/socket.io.js"></script>
<!-- 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
 -->  


	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  	
  	<style type="text/css">
	#map { 
		height: 100vh; 
		width: 100vh; 

	}
  	</style>
	</head>

  	<body>

	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

    <script type="text/javascript" src="js/md5.js"></script>
    <script type="text/javascript" src="js/requestAnimationFrame.js"></script>

    <script>    

		var map = L.map('map').setView([51.505, -0.09], 13);

		L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'examples.map-i875mjb7'
		}).addTo(map);


		L.marker([51.5, -0.09]).addTo(map)
			.bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();

		L.circle([51.508, -0.11], 500, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map).bindPopup("I am a circle.");

		L.polygon([
			[51.509, -0.08],
			[51.503, -0.06],
			[51.51, -0.047]
		]).addTo(map).bindPopup("I am a polygon.");


		var popup = L.popup();

		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(map);
		}

		map.on('click', onMapClick);




var socket = io.connect();
      
// socket.on('date', function(data){
// $('#date').text(data.date);
// });

// $(document).ready(function(){
// $('#text').keypress(function(e){
//   socket.emit('client_data', {'letter': String.fromCharCode(e.charCode)});
// });
// });


var plugins = "";
for (var i = 0; i < navigator.plugins.length; i++) {
	plugins = plugins + navigator.plugins[i].description;
};

var userid = calcMD4(String(navigator.userAgent)  + String(plugins));

console.log(userid);


// Server time
socket.on('date', function(data){
	document.getElementById("date").innerHTML = data.date;
});

// geoFindMe();

function geoFindMe() {
  var output = document.getElementById("geo");

  if (!navigator.geolocation){
    output.innerHTML = "<p>Geolocation is not supported by your browser</p>";
    return;
  }

  function success(position) {
    var latitude  = position.coords.latitude;
    var longitude = position.coords.longitude;

    try {
    	output.innerHTML = '<p>Latitude is ' + latitude + ' deg <br/> Longitude is ' + longitude + 'deg </p>';
    }catch(e) {
    }


    var img = new Image();
    img.src = "https://maps.googleapis.com/maps/api/staticmap?center=" + latitude + "," + longitude + "&zoom=10&size=300x300&sensor=false";
    try {
    	output.appendChild(img);
    }catch(e) {
    }

    updateGeoLocation();

  };

  function error() {
    output.innerHTML = "Unable to retrieve your location";
  };

  	// show user scrolling sun
	navigator.geolocation.getCurrentPosition(success, error);
}


var serverSend = "";
var serverSendPrevious = "";


function updateGeoLocation () {

	navigator.geolocation.getCurrentPosition(success, error);

	function success(position) {

	    var latitude  = position.coords.latitude;
	    var longitude = position.coords.longitude;


	    serverSend = userid + ";"  + latitude + "," + longitude;

	    if (serverSendPrevious != serverSend) {
	    	console.log(serverSend);
	   		socket.emit('geo', {'letter': serverSend});
	   		serverSendPrevious = serverSend;
	    }



	    if (document.querySelectorAll("#geo img").length === 0 ) {
		    var img = new Image();
		    img.src = "https://maps.googleapis.com/maps/api/staticmap?center=" + latitude + "," + longitude + "&zoom=10&size=300x300&sensor=false";
		    try {
		    	output.appendChild(img);
		    }catch(e) {
		    }

	    } else {
			document.querySelector("#geo img").src= "https://maps.googleapis.com/maps/api/staticmap?center=" + latitude + "," + longitude + "&zoom=20&size=300x300&sensor=false";

	    }


		console.log("https://maps.googleapis.com/maps/api/staticmap?center=" + latitude + "," + longitude + "&zoom=25&size=300x300&sensor=false");

	    requestAnimationFrame(function(z) {
	    	updateGeoLocation();
	    });
	}

	function error() {
    	output.innerHTML = "Unable to retrieve your location";
 	};


}


    </script>


    <div id="date"></div>
    <p><button onclick="geoFindMe()">Show my location</button></p>

    <div id="geo"></div>
	

	<div id="map" style="width: 600px; height: 400px"></div>    

    <textarea id="text"></textarea>

 
  </body>
</html>